<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">

    <title>SQRL | Unique Counters </title>
    <meta name="description" content>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/sqrl/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/sqrl/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"title":"Unique Counters","path":"counters/unique.html"},"data":{"navigation":{"logo":{"text":"SQRL Documentation","type":"link","path":"index.html"},"main":[{"text":"Introduction","type":"link","path":"index.html"},{"text":"Motivation","type":"link","path":"motivation.html"},{"text":"Tutorial","type":"link","path":"tutorial.html"},{"text":"Why is it unique?","type":"link","path":"unique.html"},{"text":"FAQ","type":"link","path":"faq.html"},{"text":"Examples","type":"label","children":[{"text":"Redis Database","type":"link","path":"examples/redis.html"},{"text":"REPL","type":"link","path":"examples/repl.html"},{"text":"Wikipedia","type":"link","path":"examples/wikipedia.html"}]},{"text":"Concepts","type":"label","children":[{"text":"Entities","type":"link","path":"language/entities.html"},{"text":"Labels","type":"link","path":"language/labels.html"},{"text":"Simple Counters","type":"link","path":"counters/simple.html"},{"text":"Unique Counters","type":"link","path":"counters/unique.html"},{"text":"Rate limiters","type":"link","path":"counters/ratelimit.html"},{"text":"Sessionization","type":"link","path":"counters/session.html"},{"text":"Text Pattern Matching","type":"link","path":"language/textpattern.html"},{"text":"Where Clauses","type":"link","path":"language/where.html"}]},{"text":"Standard Library","type":"label","children":[{"text":"Assert Functions","type":"link","path":"stdlib/assert.html"},{"text":"Block Functions","type":"link","path":"stdlib/block.html"},{"text":"Bool Functions","type":"link","path":"stdlib/bool.html"},{"text":"Compare Functions","type":"link","path":"stdlib/compare.html"},{"text":"Data Functions","type":"link","path":"stdlib/data.html"},{"text":"Date Functions","type":"link","path":"stdlib/date.html"},{"text":"Entity Functions","type":"link","path":"stdlib/entity.html"},{"text":"Language Functions","type":"link","path":"stdlib/language.html"},{"text":"List Functions","type":"link","path":"stdlib/list.html"},{"text":"Load Functions","type":"link","path":"stdlib/load.html"},{"text":"Log Functions","type":"link","path":"stdlib/log.html"},{"text":"Math Functions","type":"link","path":"stdlib/math.html"},{"text":"Source Functions","type":"link","path":"stdlib/source.html"},{"text":"String Functions","type":"link","path":"stdlib/string.html"},{"text":"Time Functions","type":"link","path":"stdlib/time.html"},{"text":"Type Functions","type":"link","path":"stdlib/type.html"}]},{"text":"Function Packages","type":"label","children":[{"text":"sqrl-redis-functions","type":"link","path":"packages/sqrl-redis-functions.html"},{"text":"sqrl-text-functions","type":"link","path":"packages/sqrl-text-functions.html"}]},{"text":"Defining Functions","type":"label","children":[{"text":"Simple Functions","type":"link","path":"functions/simple.html"},{"text":"Statements","type":"link","path":"functions/statement.html"},{"text":"When Clauses","type":"link","path":"functions/when.html"},{"text":"Custom Functions","type":"link","path":"functions/custom.html"}]},{"text":"Production Deployments","type":"label","children":[{"text":"Http Server","type":"link","path":"deployment/server.html"},{"text":"Async Queues","type":"link","path":"deployment/async.html"}]},{"text":"External Resources","type":"label"},{"text":"API Reference","type":"link","path":"reference/globals.html"},{"text":"Discord Chat","type":"link","path":"https://discord.gg/mMJwWT6"},{"text":"View on GitHub","type":"link","path":"https://github.com/twitter/sqrl"}]}},"config":{"timezone":"UTC","root":"/sqrl/","time_format":"HH:mm:ss","theme":"sqrl-hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot><nav class="doc-navbar"><a href="/sqrl/index.html" class="doc-navbar__logo"><img src="/sqrl/images/logo.png" class="doc-navbar__logo__img"><span class="doc-navbar__logo__text">SQRL Documentation</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1 id="Unique-Counters"><a href="#Unique-Counters" class="headerlink" title="Unique Counters"></a>Unique Counters</h1><p>Sometimes simple counters are not enough and you need more powerful counters. This is where unique counts, or <strong>time windowed set cardinalities</strong>, come into play.</p>
<h3 id="Your-first-unique-counter"><a href="#Your-first-unique-counter" class="headerlink" title="Your first unique counter"></a>Your first unique counter</h3><p>To get started we&#x2019;re going to count the number of unique credit cards used over your entire account in the last twelve hours. While simple counters are restricted to a small number of windows, with our unique counters you can specify arbitrary time windows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LET NumCreditCards := countUnique(CreditCard LAST 12 HOURS);</span><br></pre></td></tr></table></figure>
<h3 id="Grouping-unique-counts"><a href="#Grouping-unique-counts" class="headerlink" title="Grouping unique counts"></a>Grouping unique counts</h3><p>It is rare that you just want to count unique values across your whole dataset. More often than not, you will be interested in counting unique values grouped by another feature.</p>
<p>Let&#x2019;s say we wanted to create a rule that blocks payments from users who have a suspicious number of credit cards. We could accomplish that with the following rule.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LET NumCreditCards := countUnique(CreditCard BY SessionActor LAST 5 DAYS);</span><br><span class="line">CREATE RULE SuspiciousNumCreditCards WHERE NumCreditCards &gt; 4;</span><br></pre></td></tr></table></figure>
<p>Now, rather than counting all the unique credit cards we have seen for everyone, we are counting the number of cards by each individual user.</p>
<h3 id="Counting-with-conditions-and-groups"><a href="#Counting-with-conditions-and-groups" class="headerlink" title="Counting with conditions and groups"></a>Counting with conditions and groups</h3><p>Let&#x2019;s bring it together with an example that includes a WHERE condition as well. In this example we want to create a rule that picks up when a credit card is used in more than one risky country.</p>
<p>We include the number of risky countries it has been seen in inside the rule reason. Finally we mark the rule as fully rolled out, and set it to both block the action and apply a bad_credit_card label to the card that was used.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LET NumRiskyCountries := countUnique(Country BY CreditCard WHERE RiskyCountry LAST 5 DAYS);</span><br><span class="line">CREATE RULE MultiRiskyCountryCreditCard WHERE NumRiskyCountries &gt; 1</span><br><span class="line">  WITH REASON &quot;Credit card was used in ${NumRiskyCountries} risky countries in last 5 days.&quot;;</span><br><span class="line">  </span><br><span class="line">WHEN MultiRiskyCountryCreditCard</span><br><span class="line">  blockAction(),</span><br><span class="line">  addLabel(CreditCard, &quot;bad_credit_card&quot;);</span><br></pre></td></tr></table></figure>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/sqrl/script/doc.js"></script>

    

  </body>
</html>
